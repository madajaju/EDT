<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Titre de page dynamique -->
    <title>Elastic Search et Intel Optane DCPMM | Embracing Digital Transformation</title>

    <!-- SEO -->
    <link rel="canonical" href="https://www.embracingdigital.org/fr/episodes/edt-17/index.html">
    <meta name="description" content="Darren Pulsipher montre comment il a augmenté les performances d&amp;#39;Elasticsearch en utilisant la mémoire persistante Intel Optane en mode 100% d&amp;#39;application directe. Ses tests montrent une augmentation incroyable des performances de 2 fois. En doublant la capacité de débit, vous pouvez considé">
    <meta name="keywords" content="Transformation numérique, podcast, interviews, actualités, IA, cybersécurité, edge computing, gestion des données">
    <meta name="author" content="Dr. Darren W. Pulsipher">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Elastic Search et Intel Optane DCPMM | Embracing Digital Transformation — Interviews, Actualités et Communauté">
    <meta property="og:description" content="Darren Pulsipher montre comment il a augmenté les performances d&amp;#39;Elasticsearch en utilisant la mémoire persistante Intel Optane en mode 100% d&amp;#39;application directe. Ses tests montrent une augmentation incroyable des performances de 2 fois. En doublant la capacité de débit, vous pouvez considé">
    <meta property="og:url" content="https://www.embracingdigital.org/fr/episodes/edt-17/index.html">
    <meta property="og:image" content="https://embracingdigital.org/images/logo.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Elastic Search et Intel Optane DCPMM | Embracing Digital Transformation — Interviews, Actualités et Communauté">
    <meta name="twitter:description" content="Darren Pulsipher montre comment il a augmenté les performances d&amp;#39;Elasticsearch en utilisant la mémoire persistante Intel Optane en mode 100% d&amp;#39;application directe. Ses tests montrent une augmentation incroyable des performances de 2 fois. En doublant la capacité de débit, vous pouvez considé">
    <meta name="twitter:image" content="https://embracingdigital.org/images/logo.png">

    <!-- Hreflang (alternatives) -->
    <link rel="alternate" href="https://embracingdigital.org/fr/home/" hreflang="fr">
    <link rel="alternate" href="https://embracingdigital.org/de/home/" hreflang="de">
    <link rel="alternate" href="https://embracingdigital.org/it/home/" hreflang="it">
    <link rel="alternate" href="https://embracingdigital.org/pt/home/" hreflang="pt">
    <link rel="alternate" href="https://embracingdigital.org/ar/home/" hreflang="ar">
    <link rel="alternate" href="https://embracingdigital.org/ja/home/" hreflang="ja">
    <link rel="alternate" href="https://embracingdigital.org/en/home/" hreflang="en">
    <link rel="alternate" href="https://embracingdigital.org/fr/home/" hreflang="x-default">

    <!-- Favicon & Styles -->
    <link rel="icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="/css/styles.css">

    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-P4XHVE79DL"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-P4XHVE79DL');
    </script>

    <!-- Schema.org: Organization + WebSite -->
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "name": "Adopter la Transformation Numérique",
            "url": "https://embracingdigital.org/",
            "logo": "https://embracingdigital.org/images/logo.png",
            "sameAs": [
                "https://www.youtube.com/@embracingdigital",
                "https://www.linkedin.com/company/embracing-digital-transformation"
            ]
        }
    </script>
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "name": "Adopter la Transformation Numérique",
            "url": "https://embracingdigital.org/",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://embracingdigital.org/fr/search.html?query={query}",
                "query-input": "required name=query"
            }
        }
    </script>
</head>
<body>

<header role="banner">
    <!-- Logo -->
    <div class="logo-container">
        <a href="/fr/home/" aria-label="Accueil — Adopter la Transformation Numérique">
            <img src="/images/logo.png" alt="Logo — Adopter la Transformation Numérique" class="site-icon">
        </a>
    </div>

    <!-- Bascule mobile -->
    <button class="menu-toggle" aria-controls="primary-nav" aria-expanded="false" aria-label="Basculer le menu">☰</button>

    <!-- Navigation principale -->
    <nav id="primary-nav" aria-label="Principale">
        <ul>
            <li><a href="/fr/home/index.html" >Accueil</a></li>

            <li class="dropdown">
                <a href="/fr/shows/index.html" aria-haspopup="true" aria-expanded="false">Émissions</a>
                <ul class="dropdown-menu" role="menu">
                    <li role="none">
                        <a role="menuitem" href="/fr/episodes/index.html" aria-label="Interviews — Adopter la Transformation Numérique">
                            Adopter la Transformation Numérique
                            <small class="nav-note">Interviews</small>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" href="/fr/briefs/index.html" aria-label="Actualités — Le numérique cette semaine">
                            Le numérique cette semaine
                            <small class="nav-note">Actualités</small>
                        </a>
                    </li>
                </ul>
            </li>

            <li><a href="/fr/guests/index.html">Invités</a></li>
            <li><a href="/fr/articles/index.html">Articles</a></li>

            <!-- Communauté -->
            <li class="dropdown">
                <a href="/fr/community.html" aria-haspopup="true" aria-expanded="false">Communauté</a>
                <ul class="dropdown-menu" role="menu">
                    <li role="none"><a role="menuitem" href="/fr/newsletter.html">Newsletter</a></li>
                    <li role="none"><a role="menuitem" href="https://www.patreon.com/embracingdigital" target="_blank" rel="noopener">Patreon</a></li>
                    <li role="none"><a role="menuitem" href="https://www.linkedin.com/company/embracing-digital-transformation" target="_blank" rel="noopener">Groupe LinkedIn</a></li>
                </ul>
            </li>

            <li><a href="https://6704f0-2.myshopify.com/" target="_blank" rel="noopener">Boutique</a></li>

            <!-- À propos -->
            <li class="dropdown">
                <a href="/fr/about.html" aria-haspopup="true" aria-expanded="false">À propos</a>
                <ul class="dropdown-menu" role="menu">
                    <li role="none"><a role="menuitem" href="/fr/about.html">À propos de l’émission</a></li>
                    <li role="none"><a role="menuitem" href="/fr/host.html">Animateur : Dr Darren Pulsipher</a></li>
                    <li role="none"><a role="menuitem" href="/fr/sponsors/index.html">Sponsoring & Contact</a></li>
                </ul>
            </li>

            <li><a href="/fr/search.html">Recherche</a></li>

            <!-- Langues -->
            <li class="dropdown">
                <a href="#" aria-haspopup="true" aria-expanded="false">Langues</a>
                <ul class="dropdown-menu" role="menu">
                    <li role="none"><a role="menuitem" href="/ar/home/index.html">العربية</a></li>
                    <li role="none"><a role="menuitem" href="/de/home/index.html">Deutsch</a></li>
                    <li role="none"><a role="menuitem" href="/en/home/index.html">English</a></li>
                    <li role="none"><a role="menuitem" href="/es/home/index.html">Español</a></li>
                    <li role="none"><a role="menuitem" href="/fr/home/index.html">Français</a></li>
                    <li role="none"><a role="menuitem" href="/it/home/index.html">Italiano</a></li>
                    <li role="none"><a role="menuitem" href="/pt/home/index.html">Português</a></li>
                    <li role="none"><a role="menuitem" href="/ja/home/index.html">日本語</a></li>
                </ul>
            </li>
        </ul>
    </nav>
</header>



<a class="skip-link" href="#main">Skip to content</a>

<nav class="breadcrumbs" aria-label="Breadcrumb">
    <ol>
        <li><a href="../../../fr/home/index.html">Home</a></li>
        <li><a href="../../../fr/episodes/index.html">Episodes</a></li>
        <li aria-current="page">Episode 17: Elastic Search &amp; Intel Optane DCPMM</li>
    </ol>
</nav>

<main id="main" role="main">
    <article class="episode-container" itemscope itemtype="https://schema.org/PodcastEpisode">

        <header id="one-episode">
            
                <link itemprop="url" href="https://www.embracingdigital.org/fr/episodes/edt-17/index.html">
                <meta itemprop="mainEntityOfPage" content="https://www.embracingdigital.org/fr/episodes/edt-17/index.html"/>
            

            <h1 id="episode-title" itemprop="name">
                <span class="episode-number">Episode 17</span>
                <span class="episode-title">Elastic Search &amp; Intel Optane DCPMM</span>
            </h1>

            <p class="episode-meta">
                
                    <time datetime="2020-08-31" itemprop="datePublished">2020-08-31T00:00:00.000Z</time>
                
                <span itemprop="author" itemscope itemtype="https://schema.org/Person">
          <meta itemprop="name" content="Dr. Darren Pulsipher">
          Hosted by <span class="host-name">Dr. Darren Pulsipher</span>
        </span>
            </p>

            <meta itemprop="episodeNumber" content="17"/>
            <meta itemprop="inLanguage" content="fr"/>
        </header>

        
            <section class="video-container" aria-label="Watch the episode"
                     itemprop="associatedMedia" itemscope itemtype="https://schema.org/VideoObject">
                <meta itemprop="name" content="Elastic Search et Intel Optane DCPMM Video">
                <meta itemprop="embedUrl" content="https://www.youtube.com/embed/url">
                <iframe
                        width="auto"
                        height="auto"
                        src="https://www.youtube.com/embed/url"
                        title="Elastic Search et Intel Optane DCPMM Video"
                        loading="lazy"
                        referrerpolicy="strict-origin-when-cross-origin"
                        allowfullscreen
                ></iframe>
            </section>
        

        
            <section class="podcast-container" aria-label="Listen to this episode"
                     itemprop="associatedMedia" itemscope itemtype="https://schema.org/AudioObject">
                <meta itemprop="name" content="Elastic Search et Intel Optane DCPMM Audio">
                <meta itemprop="contentUrl" content="https://share.transistor.fm/e/77870513">
                <iframe
                        width="100%"
                        height="180"
                        frameborder="0"
                        scrolling="no"
                        src="https://share.transistor.fm/e/77870513"
                        title="Elastic Search et Intel Optane DCPMM Audio"
                        loading="lazy"
                ></iframe>

                <p class="listen-note">
                    Explore more in the <a href="../../../fr/episodes/index.html">episode archive</a>.
                </p>
            </section>
        

        <section class="show-summary" aria-label="Episode summary" itemprop="description">
            <h2>Summary</h2>
            <p>Darren Pulsipher montre comment il a augmenté les performances d&#39;Elasticsearch en utilisant la mémoire persistante Intel Optane en mode 100% d&#39;application directe. Ses tests montrent une augmentation incroyable des performances de 2 fois. En doublant la capacité de débit, vous pouvez considé</p>


            
                <nav class="tags" aria-label="Tags">
                    
                        <a href="../../../fr/search.html?query=intel"
                           itemprop="keywords">intel</a>
                    
                        <a href="../../../fr/search.html?query=optane"
                           itemprop="keywords">optane</a>
                    
                        <a href="../../../fr/search.html?query=moderncomputing"
                           itemprop="keywords">moderncomputing</a>
                    
                        <a href="../../../fr/search.html?query=dataanalytics"
                           itemprop="keywords">dataanalytics</a>
                    
                        <a href="../../../fr/search.html?query=multicloud"
                           itemprop="keywords">multicloud</a>
                    
                        <a href="../../../fr/search.html?query=process"
                           itemprop="keywords">process</a>
                    
                        <a href="../../../fr/search.html?query=technology"
                           itemprop="keywords">technology</a>
                    
                </nav>
            

            
                <div class="guests" aria-label="Guests">
                    
                        <span itemprop="actor" itemscope itemtype="https://schema.org/Person">
              <a href="../../../fr/guests/darren-w-pulsipher/index.html" itemprop="url">
                <span itemprop="name">Darren W Pulsipher</span>
              </a>
            </span>
                    
                </div>
            
        </section>

        <section class="show-notes" aria-label="Show notes">
            <p>Récemment, j&#39;ai effectué quelques tests avec la nouvelle technologie d&#39;Intel appelée Optane DC Persistent Memory (PMEM) avec Kafka. En utilisant Optane de manière non traditionnelle, monté en tant que système de fichiers, j&#39;ai pu obtenir une amélioration massive du débit. Écoutez mon podcast à ce sujet ici. (Pouvez-vous mettre un lien ici ?) J&#39;ai essayé la même chose avec Elasticsearch pour voir si je pouvais obtenir une amélioration similaire des performances.</p>
<p>Elasticsearch est un moteur de recherche hautement évolutif et d&#39;analyse qui permet la distribution des données sur plusieurs nœuds pour étendre la solution et prendre en charge des quantités de données plus importantes. En d&#39;autres termes, c&#39;est un gestionnaire de métadonnées distribué, principalement utilisé pour l&#39;analyse des journaux. Elastic est lui-même un excellent outil pour normaliser les données au format JSON. Je peux envoyer n&#39;importe quel type de données dans Elastic et il peut s&#39;étendre sur un cluster distribué. Ce n&#39;est pas un bus de messages comme Kafka, mais plutôt un index des données que vous recevez. Étant donné qu&#39;Elastic stocke ces données sur des disques, j&#39;ai réalisé que je pouvais utiliser le PMEM de la même manière que je l&#39;ai fait avec Kafka.</p>
<h2>Mémoire persistante Intel Optane DC</h2>
<p>La mémoire persistante Intel Optane DC est disponible dans le format DDR4, ce qui lui permet de s&#39;adapter parfaitement à votre serveur dans un emplacement de mémoire DDR4. Les modules sont disponibles en versions de 128, 256 et 512 gigaoctets, ce qui signifie qu&#39;avec un système à deux sockets, je peux avoir jusqu&#39;à 6 téraoctets de PMEM. Une fonctionnalité importante est que le matériel est chiffré et lié à votre CPU avec cet encryption, ce qui le rend sécurisé et extrêmement fiable. Il est déjà utilisé pour apporter des changements profonds dans la façon dont il est utilisé dans de nombreux outils de bases de données, tels que la plateforme Exadata d&#39;Oracle ainsi que SAP HANA.</p>
<h2>Soutien pour la variété des applications.</h2>
<p>Il y a plusieurs façons d&#39;utiliser cette technologie.</p>
<p>Le premier est le mode mémoire, qui étend l&#39;emplacement d&#39;un serveur. Il utilise le PMEM comme une mémoire normale. La mémoire DDR4 agit comme un cache pour le PMEM. Dans ce mode, la vitesse est comparable à DDR4 ; dans la plupart des applications, vous ne verrez aucun changement.</p>
<p>Le deuxième mode est l&#39;application directe. En mode application directe, je peux écrire une application qui écrit directement dans PMEM, en contournant les étapes chronophages.</p>
<p>Le troisième mode utilise le mode direct de l&#39;application pour créer un système de fichiers en mémoire non volatile qui se trouve directement sur le bus de mémoire, ce qui est bien plus rapide que le bus NVMe ou même le bus SATA.</p>
<p>En utilisant ce troisième mode, j&#39;ai dû apprendre un peu sur l&#39;architecture d&#39;Elastic pour savoir quelles parties je devais exécuter dans ce système de fichiers ultra-rapide et quelles autres je devais laisser où elles étaient. Je voulais également savoir si je pouvais effectuer ces modifications uniquement avec le fichier de configuration.</p>
<h2>Utilisation du Noyau Linux</h2>
<p>Tout d&#39;abord, j&#39;ai dû apprendre à utiliser les commandes du noyau Linux pour manipuler cette PMEM.</p>
<p>Avec la commande de contrôle de la mémoire persistante Intel (ipmctl), j&#39;ai découvert que je pouvais configurer et gérer la PMEM de manière à pouvoir l&#39;allouer pour fonctionner en mode mémoire, en mode direct d&#39;application ou en un pourcentage de mode mémoire.</p>
<p>L&#39;autre commande est le contrôle du dispositif de mémoire non volatile (ndctl). Cela me permet de créer des espaces de noms et des régions dans cette PMEM que j&#39;ai créée, afin que je puisse monter cette région en tant que dispositif. Ensuite, je peux monter ce dispositif en tant que système de fichiers.</p>
<h2>ESRally est un outil de test de performance.</h2>
<p>J&#39;ai trouvé ESRally, un outil de benchmark, à utiliser dans mes tests. La première fois que j&#39;ai configuré le test, j&#39;ai exécuté ESRally depuis mon disque SATA normal, où Elastic exécutait tout à partir du disque PMEM. J&#39;ai obtenu une certaine amélioration des performances, mais ce que j&#39;ai découvert, c&#39;est que parce que je diffusais des données à partir du disque SATA stockées dans mon ESRally, j&#39;étais limité par la vitesse à laquelle je pouvais pousser les données dans Elasticsearch. Ce n&#39;était donc pas Elastic qui ralentissait, mais ESRally car mon disque SATA était beaucoup plus lent que mon disque PMEM. J&#39;ai déplacé ESRally sur le disque PMEM. Cela a amélioré les performances et j&#39;ai obtenu quelques résultats intéressants.</p>
<h2>Tests de contraintes</h2>
<p>Pour voir quels seraient les effets de cette unité de stockage PMEM ultra-rapide sur Elastic, j&#39;ai effectué le test sur une seule machine. Cela a éliminé la variabilité du réseau, supprimant ainsi les goulets d&#39;étranglement liés à ce dernier en tant que facteur limitant. J&#39;ai réduit les communications entre les services, ce qui a réduit les goulets d&#39;étranglement des répliques, et j&#39;ai exécuté toutes les requêtes sur des PMEM, éliminant ainsi la variabilité du disque SATA.</p>
<h2>Performance optimale (100%) App Direct</h2>
<p>D&#39;abord, j&#39;ai attribué tout le PMEM au mode d&#39;accès direct de l&#39;application afin de pouvoir monter l&#39;ensemble en tant que système de fichiers. J&#39;ai utilisé des DIMMS de 128 gigaoctets, donc j&#39;avais un disque de 1,5 téraoctets que je pouvais utiliser. Je savais d&#39;après mes tests précédents avec Kafka que j&#39;obtiens de meilleures performances avec un mode d&#39;accès direct de l&#39;application à 100% plutôt qu&#39;à 50%.</p>
<p>Débit médian (devrait être Throughput - peut être modifié sur la diapositive) docs/sec</p>
<p>En utilisant les statistiques d&#39;ESRally, j&#39;ai pris le débit médian en documents par seconde par rapport au nombre de courses concurrentes que j&#39;exécutais en même temps avec des producteurs et des consommateurs. J&#39;ai obtenu de bons résultats avec le disque SATA, comparables à d&#39;autres tests publiés. Avec le disque PMEM, j&#39;ai pu ingérer presque deux fois plus de documents par seconde. C&#39;est assez incroyable étant donné qu&#39;il n&#39;y a eu aucun changement de code, juste une modification de configuration.</p>
<h2>Temps de réponse du service</h2>
<p>L&#39;autre résultat était le temps de réponse aux fonctions. Comme prévu, à mesure que le nombre de courses simultanées augmentait, le temps de réponse à ces requêtes ou fonctions augmentait également. Mais avec PMEM, le temps de réponse est presque deux fois plus rapide. À partir de ce simple test, j&#39;ai appris que l&#39;endroit où vous stockez les données dont Elasticsearch a besoin (PMEM ou SATA) a un effet sur le temps de réponse.</p>
<h2>Conclusion</h2>
<p>Utiliser la mémoire persistante Optane en mode système de fichiers pour augmenter les performances et réduire les coûts des serveurs Elasticsearch nécessite des changements minimes dans la configuration matérielle et logicielle, sans modification d&#39;Elasticsearch ni des applications sous-jacentes. En doublant la capacité de débit de votre Elasticsearch, vous pouvez réduire le nombre total de serveurs dans votre cluster Elasticsearch, ce qui diminue le coût total de possession.</p>
<h2>Pour plus d&#39;informations</h2>
<p>Pour plus d&#39;informations détaillées, consultez le lien du podcast vers le document que nous avons créé en réponse à ces résultats de tests. Vous pouvez également me contacter à l&#39;adresse <a href="mailto:darren.w.pulsipher@intel.com">darren.w.pulsipher@intel.com</a> ou sur LinkedIn @darrenpulsipher.</p>

        </section>

        

    </article>
</main>

<!-- Structured Data -->
<script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "PodcastSeries",
  "@id": "https://www.embracingdigital.org/fr/episodes/index.html#series",
  "name": "Embracing Digital Transformation",
  "url": "https://www.embracingdigital.org/fr/episodes/index.html",
  "inLanguage": "fr",
  "description": "A podcast about the digital transformation of the world.",
  "publisher": {
    "@type": "Organization",
    "@id": "https://www.embracingdigital.org/#org",
    "name": "Embracing Digital Transformation",
    "url": "https://www.embracingdigital.org",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.embracingdigital.org/images/logo.png",
      "width": 512,
      "height": 512
    }
  }
}</script>
<script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "PodcastEpisode",
  "@id": "https://www.embracingdigital.org/fr/episodes/edt-17/index.html#episode",
  "url": "https://www.embracingdigital.org/fr/episodes/edt-17/index.html",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.embracingdigital.org/fr/episodes/edt-17/index.html"
  },
  "name": "Elastic Search et Intel Optane DCPMM",
  "episodeNumber": 17,
  "datePublished": "2020-08-31",
  "inLanguage": "fr",
  "description": "Darren Pulsipher montre comment il a augmenté les performances d&#39;Elasticsearch en utilisant la mémoire persistante Intel Optane en mode 100% d&#39;application directe. Ses tests montrent une augmentation incroyable des performances de 2 fois. En doublant la capacité de débit, vous pouvez considé",
  "partOfSeries": {
    "@id": "https://www.embracingdigital.org/fr/episodes/index.html#series"
  },
  "author": {
    "@type": "Person",
    "name": "Dr. Darren Pulsipher"
  },
  "creator": {
    "@type": "Person",
    "name": "Dr. Darren Pulsipher"
  },
  "image": {
    "@type": "ImageObject",
    "url": "https://www.embracingdigital.org/fr/episodes/edt-17/thumbnail.png"
  },
  "associatedMedia": [
    {
      "@type": "VideoObject",
      "name": "Elastic Search et Intel Optane DCPMM Video",
      "embedUrl": "https://www.youtube.com/embed/url"
    },
    {
      "@type": "AudioObject",
      "name": "Elastic Search et Intel Optane DCPMM Audio",
      "contentUrl": "https://share.transistor.fm/e/77870513"
    }
  ],
  "actor": [
    {
      "@type": "Person",
      "name": "Darren W Pulsipher",
      "url": "https://www.embracingdigital.org/../../../fr/guests/darren-w-pulsipher/index.html"
    }
  ]
}</script>

<footer id="footer">
    <div class="footer-content">
        <p>Droit d'auteur &copy; 2025 Paidar Productions LLC</p>
        <p>Tous droits réservés</p>
    </div>
</footer>
<script>
    // year
    (function(){ var y=document.getElementById('y'); if(y){ y.textContent = new Date().getFullYear(); } })();

    // Guard for pages without nav
    const toggle = document.querySelector('.menu-toggle');
    const nav    = document.querySelector('nav#primary-nav');
    if (nav) {
        // Mobile: toggle .menu-open on <body>
        toggle?.addEventListener('click', () => {
            const open = document.body.classList.toggle('menu-open');
            toggle.setAttribute('aria-expanded', String(open));
        });

        // Dropdowns: tap/click + keyboard
        document.querySelectorAll('li.dropdown > a').forEach(link => {
            const li = link.parentElement;
            const submenu = li.querySelector('.dropdown-menu');

            link.addEventListener('click', (e) => {
                if (!submenu) return;
                e.preventDefault();

                // close others
                document.querySelectorAll('li.dropdown.open > a').forEach(a => {
                    if (a !== link) {
                        a.setAttribute('aria-expanded', 'false');
                        a.parentElement.classList.remove('open');
                    }
                });

                const isOpen = li.classList.toggle('open');
                link.setAttribute('aria-expanded', String(isOpen));
            });

            link.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowDown') { e.preventDefault(); submenu?.querySelector('a')?.focus(); }
                if (e.key === 'Escape')    { li.classList.remove('open'); link.setAttribute('aria-expanded','false'); link.focus(); }
            });
        });

        // Close dropdowns on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('nav')) {
                document.querySelectorAll('li.dropdown.open > a').forEach(a => {
                    a.setAttribute('aria-expanded','false');
                    a.parentElement.classList.remove('open');
                });
            }
        });
    }
</script>

