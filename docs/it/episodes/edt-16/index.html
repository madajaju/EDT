<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Titolo pagina dinamico -->
    <title>Embracing Digital Transformation</title>

    <!-- SEO -->
    <link rel="canonical" href="https://embracingdigital.org/it/home/">
    <meta name="description" content="&lt;p&gt;In questo episodio, Darren parla della diminuzione della congestione dell&amp;#39;ingestione utilizzando la memoria persistente Optane DC di Intel e dell&amp;#39;esperimento da lui condotto con risultati sorprendenti. Potrebbe cambiare il modo in cui pensiamo alla programmazione in futuro.&lt;/p&gt;
">
    <meta name="keywords" content="Trasformazione digitale, podcast, interviste, notizie, IA, cybersicurezza, edge computing, gestione dei dati">
    <meta name="author" content="Dr. Darren W. Pulsipher">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Embracing Digital Transformation — Interviste, Notizie e Community">
    <meta property="og:description" content="&lt;p&gt;In questo episodio, Darren parla della diminuzione della congestione dell&amp;#39;ingestione utilizzando la memoria persistente Optane DC di Intel e dell&amp;#39;esperimento da lui condotto con risultati sorprendenti. Potrebbe cambiare il modo in cui pensiamo alla programmazione in futuro.&lt;/p&gt;
">
    <meta property="og:url" content="https://embracingdigital.org/it/home/">
    <meta property="og:image" content="https://embracingdigital.org/images/logo.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Embracing Digital Transformation — Interviste, Notizie e Community">
    <meta name="twitter:description" content="&lt;p&gt;In questo episodio, Darren parla della diminuzione della congestione dell&amp;#39;ingestione utilizzando la memoria persistente Optane DC di Intel e dell&amp;#39;esperimento da lui condotto con risultati sorprendenti. Potrebbe cambiare il modo in cui pensiamo alla programmazione in futuro.&lt;/p&gt;
">
    <meta name="twitter:image" content="https://embracingdigital.org/images/logo.png">

    <!-- Hreflang (alternative) -->
    <link rel="alternate" href="https://embracingdigital.org/it/home/" hreflang="it">
    <link rel="alternate" href="https://embracingdigital.org/de/home/" hreflang="de">
    <link rel="alternate" href="https://embracingdigital.org/fr/home/" hreflang="fr">
    <link rel="alternate" href="https://embracingdigital.org/pt/home/" hreflang="pt">
    <link rel="alternate" href="https://embracingdigital.org/ar/home/" hreflang="ar">
    <link rel="alternate" href="https://embracingdigital.org/ja/home/" hreflang="ja">
    <link rel="alternate" href="https://embracingdigital.org/en/home/" hreflang="en">
    <link rel="alternate" href="https://embracingdigital.org/it/home/" hreflang="x-default">

    <!-- Favicon & Stili -->
    <link rel="icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="/css/styles.css">

    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-P4XHVE79DL"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-P4XHVE79DL');
    </script>

    <!-- Schema.org: Organization + WebSite -->
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "name": "Abbracciare la Trasformazione Digitale",
            "url": "https://embracingdigital.org/",
            "logo": "https://embracingdigital.org/images/logo.png",
            "sameAs": [
                "https://www.youtube.com/@embracingdigital",
                "https://www.linkedin.com/company/embracing-digital-transformation"
            ]
        }
    </script>
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "name": "Abbracciare la Trasformazione Digitale",
            "url": "https://embracingdigital.org/",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://embracingdigital.org/it/search.html?query={query}",
                "query-input": "required name=query"
            }
        }
    </script>
</head>
<body>

<header role="banner">
    <!-- Logo -->
    <div class="logo-container">
        <a href="/it/home/" aria-label="Home — Abbracciare la Trasformazione Digitale">
            <img src="/images/logo.png" alt="Logo — Abbracciare la Trasformazione Digitale" class="site-icon">
        </a>
    </div>

    <!-- Toggle mobile -->
    <button class="menu-toggle" aria-controls="primary-nav" aria-expanded="false" aria-label="Apri/chiudi menu">☰</button>

    <!-- Navigazione principale -->
    <nav id="primary-nav" aria-label="Principale">
        <ul>
            <li><a href="/it/home/index.html" >Home</a></li>

            <li class="dropdown">
                <a href="/it/shows/index.html" aria-haspopup="true" aria-expanded="false">Programmi</a>
                <ul class="dropdown-menu" role="menu">
                    <li role="none">
                        <a role="menuitem" href="/it/episodes/index.html" aria-label="Interviste — Abbracciare la Trasformazione Digitale">
                            Abbracciare la Trasformazione Digitale
                            <small class="nav-note">Interviste</small>
                        </a>
                    </li>
                    <li role="none">
                        <a role="menuitem" href="/it/briefs/index.html" aria-label="Notizie — Digitale questa settimana">
                            Digitale questa settimana
                            <small class="nav-note">Notizie</small>
                        </a>
                    </li>
                </ul>
            </li>

            <li><a href="/it/guests/index.html">Ospiti</a></li>
            <li><a href="/it/articles/index.html">Articoli</a></li>

            <!-- Community -->
            <li class="dropdown">
                <a href="/it/community.html" aria-haspopup="true" aria-expanded="false">Community</a>
                <ul class="dropdown-menu" role="menu">
                    <li role="none"><a role="menuitem" href="/it/newsletter.html">Newsletter</a></li>
                    <li role="none"><a role="menuitem" href="https://www.patreon.com/embracingdigital" target="_blank" rel="noopener">Patreon</a></li>
                    <li role="none"><a role="menuitem" href="https://www.linkedin.com/company/embracing-digital-transformation" target="_blank" rel="noopener">Gruppo LinkedIn</a></li>
                </ul>
            </li>

            <li><a href="https://6704f0-2.myshopify.com/" target="_blank" rel="noopener">Shop</a></li>

            <!-- Informazioni -->
            <li class="dropdown">
                <a href="/it/about.html" aria-haspopup="true" aria-expanded="false">Informazioni</a>
                <ul class="dropdown-menu" role="menu">
                    <li role="none"><a role="menuitem" href="/it/about.html">Informazioni sul programma</a></li>
                    <li role="none"><a role="menuitem" href="/it/host.html">Conduttore: Dr. Darren Pulsipher</a></li>
                    <li role="none"><a role="menuitem" href="/it/sponsors/index.html">Sponsorizzazioni e contatti</a></li>
                </ul>
            </li>

            <li><a href="/it/search.html">Cerca</a></li>

            <!-- Lingue -->
            <li class="dropdown">
                <a href="#" aria-haspopup="true" aria-expanded="false">Lingue</a>
                <ul class="dropdown-menu" role="menu">
                    <li role="none"><a role="menuitem" href="/ar/home/index.html">العربية</a></li>
                    <li role="none"><a role="menuitem" href="/de/home/index.html">Deutsch</a></li>
                    <li role="none"><a role="menuitem" href="/en/home/index.html">English</a></li>
                    <li role="none"><a role="menuitem" href="/es/home/index.html">Español</a></li>
                    <li role="none"><a role="menuitem" href="/fr/home/index.html">Français</a></li>
                    <li role="none"><a role="menuitem" href="/it/home/index.html">Italiano</a></li>
                    <li role="none"><a role="menuitem" href="/pt/home/index.html">Português</a></li>
                    <li role="none"><a role="menuitem" href="/ja/home/index.html">日本語</a></li>
                </ul>
            </li>
        </ul>
    </nav>
</header>

<section id="one-episode"
         itemscope itemtype="https://schema.org/PodcastEpisode">
  <meta itemprop="mainEntityOfPage" content=""/>
  <header>
    <h1 id="episode-title" itemprop="name">
      #16 <span>Ridurre la congestione di ingestione con Intel Optane DCPMM</span>
    </h1>
    <time datetime="2020-08-25T00:00:00.000Z"
          itemprop="datePublished">
      2020-08-25T00:00:00.000Z
    </time>
    <meta itemprop="episodeNumber" content="16"/>
  </header>

  <!-- VideoObject -->
  <div class="video-container" itemprop="associatedMedia"
       itemscope itemtype="https://schema.org/VideoObject">
    <meta itemprop="name" content="Ridurre la congestione di ingestione con Intel Optane DCPMM">
    <meta itemprop="embedUrl"
          content="https://www.youtube.com/embed/url">
    <iframe width="auto" height="auto"
            src="https://www.youtube.com/embed/url?autoplay=1"
            title="Ridurre la congestione di ingestione con Intel Optane DCPMM Video"></iframe>
  </div>

  <!-- AudioObject -->
  <aside class="podcast-container" itemprop="associatedMedia"
         itemscope itemtype="https://schema.org/AudioObject">
    <meta itemprop="name" content="Ridurre la congestione di ingestione con Intel Optane DCPMM">
    <meta itemprop="contentUrl"
          content="https://share.transistor.fm/e/7ca179aa">
    <iframe width="100%" height="180" frameborder="0" scrolling="no"
            src="https://share.transistor.fm/e/7ca179aa"
            title="Ridurre la congestione di ingestione con Intel Optane DCPMM Audio"></iframe>
  </aside>

  <div class="show-summary" itemprop="description">
    <p><p>In questo episodio, Darren parla della diminuzione della congestione dell&#39;ingestione utilizzando la memoria persistente Optane DC di Intel e dell&#39;esperimento da lui condotto con risultati sorprendenti. Potrebbe cambiare il modo in cui pensiamo alla programmazione in futuro.</p>
</p>
    <nav class="tags" aria-label="Tags">
      
        <a href="../../../it/search.html?query=artificialintelligence"
           itemprop="keywords">artificialintelligence</a>
      
        <a href="../../../it/search.html?query=machinelearning"
           itemprop="keywords">machinelearning</a>
      
        <a href="../../../it/search.html?query=edgecomputing"
           itemprop="keywords">edgecomputing</a>
      
        <a href="../../../it/search.html?query=datamanagement"
           itemprop="keywords">datamanagement</a>
      
        <a href="../../../it/search.html?query=multicloud"
           itemprop="keywords">multicloud</a>
      
        <a href="../../../it/search.html?query=zerotrust"
           itemprop="keywords">zerotrust</a>
      
        <a href="../../../it/search.html?query=process"
           itemprop="keywords">process</a>
      
        <a href="../../../it/search.html?query=technology"
           itemprop="keywords">technology</a>
      
    </nav>
    <div class="guests" itemprop="actor" itemscope itemtype="https://schema.org/Person">
      
        <a href="../../../it/guests/darren-w-pulsipher/index.html"
           itemprop="name" target="_blank">Darren W Pulsipher</a>
      
    </div>
  </div>

  <div class="show-notes" itemprop="transcript">
    <h2>Dettagli sullo stack di servizi</h2>
<p>Un cliente nel settore automobilistico stava avendo difficoltà nel riuscire ad ottenere in modo efficace informazioni dalle proprie auto e trasferirle nel loro data center in modo da poter effettuare apprendimento automatico e analisi dati. In questa area è stata condotta una ricerca, ma solo per un numero limitato di auto, non per i cento milioni di auto del cliente. Quando ho esaminato l&#39;intera struttura del loro servizio e come tutto arrivava al data center, è emerso che l&#39;ingestione dei dati era il problema principale: come posso assimilare così tanti dati e come posso farlo velocemente?</p>
<h2>Panoramica dell&#39;architettura Kafka a livello superiore.</h2>
<p>Il cliente voleva utilizzare Kafka per l&#39;ingestione dei dati. Kafka è un intermediario che può scalare bene e la sua caratteristica principale è quella di poter gestire diversi produttori, consumatori differenti e una grande quantità di dati. Utilizzare diversi intermediari Kafka per posizionare e inviare dati nei luoghi più appropriati offre una grande flessibilità.</p>
<p>Kafka, tuttavia, è stato principalmente progettato per dimensioni dei messaggi di circa uno a 10 kilobytes e i dati del cliente erano di circa 240 kilobytes per automobile. Ci sono soluzioni alternative, ma volevo portare l&#39;intero messaggio di 240 kilobytes nel bus di Kafka in modo da poterlo spostare come necessario.</p>
<h2>Pratiche ottimali per le performance</h2>
<p>Ho analizzato le migliori pratiche di performance di coloro che lavorano con Kafka per vedere se potevo adattarle alle esigenze del mio cliente. Aumentare la dimensione del buffer per ospitare l&#39;intero messaggio è una soluzione di fine-tuning, insieme alla gestione delle dimensioni dei batch per prestazioni ottimali. Un&#39;altra pratica di successo è distribuire i log. La flessibilità di Kafka mi consentirebbe di inserire i dati in diversi argomenti. Posso suddividere gli argomenti in diverse partizioni che posso distribuire su più unità. La domanda è, dunque, su quante unità sto distribuendo i log di Kafka? Inoltre, desidero le unità più veloci possibili.</p>
<p>Un esempio che ho esaminato è LinkedIn. I numeri pubblicati da loro di un anno fa indicano che possono gestire 13 milioni di messaggi al secondo, o 2,7 gigabyte al secondo. Dicono di avere circa 1.100 broker Kafka e più di 60 su un cluster, quindi si tratta di una configurazione abbastanza grande.</p>
<h2>Spazio automobilistico</h2>
<p>Se guardo i numeri grezzi del cliente (1,6 milioni di messaggi al secondo e 800 gigabyte al secondo) e li confronto con LinkedIn, che probabilmente non è ottimizzato per 240 kilobyte, ottengo 44.000 broker. Se lo ottimizzassi, potrei probabilmente ridurli a 4.400 broker, che sono ancora 240 cluster. È un enorme quantità di macchine, quindi ho dovuto trovare un modo per rendere le cose più veloci. Con ulteriori ottimizzazioni, potrei probabilmente ridurlo a 400-500 broker, ma volevo vedere cos&#39;altro potevo fare.</p>
<h2>Intel Optane DC Persistent Memory:</h2>
<p>Memoria persistente Intel Optane DC</p>
<p>Ho esaminato la nostra memoria persistente Optane. Si adatta al formato DDR4, quindi si posiziona direttamente sul bus DDR4. Arriva fino a moduli da 512 gigabyte, quindi in un server a due socket posso avere sei terabyte di memoria persistente. Volevo trovare un modo per sfruttare questa tecnologia altamente affidabile con ottime funzionalità come la crittografia hardware integrata per aiutarmi a risolvere questo problema.</p>
<h2>Supporto per la Variazione di Applicazioni</h2>
<p>Ci sono due modalità di funzionamento con questa Memoria Optane: modalità app diretta e modalità memoria. La modalità memoria è semplice. Utilizza la memoria persistente come una normale RAM perché è più economica rispetto alla normale DDR4. Non è esattamente la stessa cosa della DDR4, ma è abbastanza simile al punto che nella maggior parte delle applicazioni non si nota alcuna differenza. Nella modalità app diretta, è possibile scrivere direttamente dalla tua applicazione nella memoria persistente. In questo modo, non è necessario convertire e decodificare le strutture dati e trasmetterle come flusso; posso semplicemente inserirle nella memoria persistente. Posso anche montare la modalità app diretta come un sistema di file, in modo che sia sul bus di memoria, molto più veloce rispetto al bus di I/O. Ora, cosa posso fare con questa memoria?</p>
<h2>Utilizzando il kernel Linux</h2>
<p>Ci sono due strumenti principali disponibili utilizzando il kernel Linux: ndctl e ipmctl. Ndctl è un controller per dispositivi di memoria non volatile, mentre c&#39;è anche IPM, il controller di memoria persistente Intel, che mi permette di manipolare e controllare questa memoria persistente. Posso configurarla in modalità memoria o modalità app diretta. Ho dovuto imparare un po&#39; su questi strumenti e come funzionano.</p>
<h2>Approccio di ingestione</h2>
<p>Il mio primo pensiero è stato che se avessi dato a Kafka molta più memoria con dimensioni di buffer grandi, avrebbe dovuto funzionare molto più velocemente. I cambiamenti del codice nella configurazione sarebbero stati superflui o minimi. Un&#39;altra opzione era cambiare Kafka in modo da scrivere sulla memoria persistente anziché sul file system, aggirando l&#39;hard disk. L&#39;ultima cosa che ho esaminato è stata la creazione di un file system persistente utilizzando la memoria persistente e quindi mettendo i log di Kafka su questo nuovo file system.</p>
<p>La opzione più semplice tra le tre era la prima: più memoria. Ho eseguito tutti i miei compiti con più memoria e non c&#39;è stata alcuna variazione delle prestazioni. I motivi sono che alla fine i miei buffer si sono riempiti e ho dovuto trasferire i dati su un&#39;unità esterna. Alla fine tutto doveva passare per i log di Kafka, che erano il mio collo di bottiglia.</p>
<p>La seconda opzione prevede la riscrittura del codice e l&#39;attesa delle approvazioni, quindi sono passato alla terza opzione. I risultati di questo esperimento, in cui ho indirizzato i log a questo nuovo file system ultra veloce, sono stati affascinanti. Diamo uno sguardo al processo e ai risultati.</p>
<h2>Test dei vincoli</h2>
<p>Per eliminare gli ostacoli alla valutazione delle prestazioni, ho escluso il network dall&#39;equazione facendo girare il mio test sulla stessa macchina su cui era presente il mio broker. Inoltre, ho eseguito solo i produttori, poi solo i consumatori, e infine una combinazione dei due, in modo da poter valutare le differenze. Il mio obiettivo non era quello di valutare il miglioramento totale della produzione, ma di analizzare singolarmente il broker per capire se questo drive avrebbe davvero fatto la differenza.</p>
<h2>Primo Approccio 50/50</h2>
<p>La prima cosa che ho fatto è stata prendere la metà della mia memoria persistente in modalità diretta dell&#39;app e trasformarla in un sistema di file. Ho lasciato l&#39;altra metà come memoria. Ho utilizzato i comandi ndctl e ipmctl e creato spazi di nomi. Ho montato questi sistemi di file e ho eseguito il mio test.</p>
<h2>Cambiare la dimensione del messaggio</h2>
<p>Ho eseguito i test su diverse dimensioni di messaggio. Mi aspettavo alcune ottimizzazioni, soprattutto per 1 kilobyte. Ho notato che ottenivo prestazioni sempre migliori fino a circa 10 produttori. Oltre i 10 produttori, ho iniziato a saturare il bus e ho ottenuto qualche variabilità. Questo mi indica che stavo memorizzando le cose nella cache. Ora potrei confrontare questi numeri con quelli ottenuti precedentemente con un solo disco SATA per i registri Kafka. Ho provato anche i nostri dischi Optane NVMe per i registri.</p>
<h2>Confronto tecnologico</h2>
<p>Diamo un&#39;occhiata alle differenze. Per 240 kilobyte, con un normale disco SATA, è piuttosto piatto. Ho ottenuto un certo miglioramento, e poi è diminuito man mano che il numero di produttori aumentava. Con il disco Optane NVMe, ho ottenuto un bel picco, quasi due volte più veloce di un disco SATA, il che è quello che mi aspettavo dato che è un bus NVMe invece di un bus SATA. Il Pmem è quasi cinque volte più veloce di un disco SATA e due volte e mezzo più veloce del disco Optane NVMe. Questo perché sto usando un bus di memoria invece del bus SATA o NVMe.</p>
<h2>Ottimizzazione aggiuntiva (100% diretto all&#39;app)</h2>
<p>Questo stava funzionando velocemente e stavo rapidamente riempiendo questo disco temporaneo da 750 GB. Siccome avevo bisogno di far durare il test un po&#39; più a lungo, sono tornato indietro e ho riconfigurato la mia macchina per eseguire una modalità di applicazione diretta al 100 percento in modo da poter ora prendere l&#39;intero terabyte e mezzo (1.5 terabyte).</p>
<h2>Ottimizzato PMEM e App Direct al 100%.</h2>
<p>Dopo aver fatto ciò e aver eseguito gli stessi test, ho ottenuto un risultato sorprendente. Ho potuto aggiungere più produttori e la mia capacità di trasmissione è aumentata di quasi altre due o tre volte. Ora è tra 12 e 15 volte più veloce di un disco SATA con 25-30 produttori e una dimensione dei messaggi di 240 kilobyte. Questo è incredibile e ridurrebbe notevolmente la necessità dei miei clienti di utilizzare così tanti broker, righe e righe di macchine. Ho eseguito il test diverse volte perché non credevo ai risultati che stavo ottenendo. Ho chiamato uno dei nostri architetti che ha progettato questa tecnologia e ho appreso che una delle ragioni per l&#39;aumento della velocità è che, quando usavo parte della memoria persistente come memoria, i dati dovevano passare attraverso due o tre salti non necessari con l&#39;app direct mode. Ciò crea meno contesa sul bus di memoria e la capacità di trasmissione è aumentata in modo significativo.</p>
<h2>Chiamata all&#39;azione</h2>
<p>Il risultato finale è che sono stato in grado di utilizzare Kafka con Optane DC Persistent Memory come un sistema di file ultra-veloce per ottenere notevoli miglioramenti nella velocità di throughput sia per i produttori che per i consumatori. Un singolo broker può gestire fino a 15 volte più messaggi e throughput rispetto a prima, diminuendo il numero di server necessari per gestire architetture di sistemi grandi e complesse. È ora di valutare la tua attuale architettura e vedere se questo potrebbe beneficiare la tua organizzazione.</p>

  </div>

  <div class="sponsor-container">
    <p>Thank you to our sponsors for supporting this episode!</p>
    <ol>
      
    </ol>
  </div>
</section>

<!-- PodcastEpisode JSON-LD -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "PodcastEpisode",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": ""
  },
  "name": "Ridurre la congestione di ingestione con Intel Optane DCPMM",
  "episodeNumber": "16",
  "datePublished": "2020-08-25T00:00:00.000Z",
  "description": "<p>In questo episodio, Darren parla della diminuzione della congestione dell&#39;ingestione utilizzando la memoria persistente Optane DC di Intel e dell&#39;esperimento da lui condotto con risultati sorprendenti. Potrebbe cambiare il modo in cui pensiamo alla programmazione in futuro.</p>
",
  "associatedMedia": [
    {
      "@type": "VideoObject",
      "name": "Ridurre la congestione di ingestione con Intel Optane DCPMM Video",
      "embedUrl": "https://www.youtube.com/embed/url"
    },
    {
      "@type": "AudioObject",
      "name": "Ridurre la congestione di ingestione con Intel Optane DCPMM Audio",
      "contentUrl": "https://share.transistor.fm/e/7ca179aa"
    }
  ],
  "actor": [
    
    {
      "@type": "Person",
      "name": "Darren W Pulsipher"
    }
    
  ],
  "publisher": {
    "@type": "Organization",
    "name": "Embracing Digital Transformation",
    "logo": {
      "@type": "ImageObject",
      "url": "https://embracingdigital.org/images/logo.png"
    }
  }
}
</script>
<footer id="footer">
    <div class="footer-content">
        <p>Copyright &copy; 2025 Paidar Productions LLC</p>
        <p>Diritti riservati</p>
    </div>
</footer>
<script>
    // year
    (function(){ var y=document.getElementById('y'); if(y){ y.textContent = new Date().getFullYear(); } })();

    // Guard for pages without nav
    const toggle = document.querySelector('.menu-toggle');
    const nav    = document.querySelector('nav#primary-nav');
    if (nav) {
        // Mobile: toggle .menu-open on <body>
        toggle?.addEventListener('click', () => {
            const open = document.body.classList.toggle('menu-open');
            toggle.setAttribute('aria-expanded', String(open));
        });

        // Dropdowns: tap/click + keyboard
        document.querySelectorAll('li.dropdown > a').forEach(link => {
            const li = link.parentElement;
            const submenu = li.querySelector('.dropdown-menu');

            link.addEventListener('click', (e) => {
                if (!submenu) return;
                e.preventDefault();

                // close others
                document.querySelectorAll('li.dropdown.open > a').forEach(a => {
                    if (a !== link) {
                        a.setAttribute('aria-expanded', 'false');
                        a.parentElement.classList.remove('open');
                    }
                });

                const isOpen = li.classList.toggle('open');
                link.setAttribute('aria-expanded', String(isOpen));
            });

            link.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowDown') { e.preventDefault(); submenu?.querySelector('a')?.focus(); }
                if (e.key === 'Escape')    { li.classList.remove('open'); link.setAttribute('aria-expanded','false'); link.focus(); }
            });
        });

        // Close dropdowns on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('nav')) {
                document.querySelectorAll('li.dropdown.open > a').forEach(a => {
                    a.setAttribute('aria-expanded','false');
                    a.parentElement.classList.remove('open');
                });
            }
        });
    }
</script>

